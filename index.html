<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT M | SOAP PROTOCOL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --panel: #111;
            --border: #333;
            --accent: #00ff41; /* Hacker Green */
            --danger: #ff3333;
            --text: #eee;
            --font-mono: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-mono);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- CUSTOM MODAL STYLES --- */
        #pm-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }

        .pm-modal-box {
            background: var(--panel);
            border: 1px solid var(--accent);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.1);
            animation: glitch-anim 0.2s ease-out;
        }

        .pm-modal-header {
            background: rgba(0, 255, 65, 0.1);
            color: var(--accent);
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
            letter-spacing: 1px;
            font-size: 14px;
        }

        .pm-modal-content {
            padding: 20px;
            font-size: 15px;
            line-height: 1.5;
            text-align: center;
        }

        .pm-modal-input {
            width: 100%;
            background: black;
            border: 1px solid #555;
            color: white;
            padding: 10px;
            margin-top: 15px;
            font-family: var(--font-mono);
            display: none; /* Hidden unless prompt */
        }
        .pm-modal-input:focus { outline: 1px solid var(--accent); }

        .pm-modal-actions {
            display: flex;
            border-top: 1px solid var(--border);
        }

        .pm-modal-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #888;
            padding: 15px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .pm-modal-btn:hover { background: #222; color: white; }
        
        .pm-btn-confirm { border-left: 1px solid var(--border); color: var(--accent); }
        .pm-btn-confirm:hover { background: var(--accent); color: black; }
        
        /* Danger state for Confirm buttons */
        .pm-modal-box.danger { border-color: var(--danger); box-shadow: 0 0 30px rgba(255, 50, 50, 0.15); }
        .pm-modal-box.danger .pm-modal-header { color: var(--danger); background: rgba(255, 50, 50, 0.1); }
        .pm-modal-box.danger .pm-btn-confirm { color: var(--danger); }
        .pm-modal-box.danger .pm-btn-confirm:hover { background: var(--danger); color: white; }

        @keyframes glitch-anim {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- EXISTING STYLES --- */

        /* DISCLAIMER MODAL (Initial Load) */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--panel);
            border: 2px solid var(--danger);
            padding: 30px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 50, 50, 0.2);
        }
        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
            padding: 15px 30px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
        }
        .btn-danger:hover { background: #cc0000; }

        /* MAIN APP */
        #app-container {
            max-width: 800px;
            width: 100%;
            filter: blur(5px);
            pointer-events: none;
            flex-grow: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }
        h1 { margin: 0; letter-spacing: -2px; }
        .status-dot { color: var(--accent); }

        /* COLLAPSIBLE GUIDE SECTION */
        .guide-panel {
            background: rgba(0, 255, 65, 0.05);
            border: 1px dashed var(--accent);
            margin-bottom: 30px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .guide-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            user-select: none;
        }
        .guide-header:hover {
            background: rgba(0, 255, 65, 0.1);
        }
        .guide-arrow {
            font-size: 12px;
            transition: transform 0.3s;
        }
        .guide-steps {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
            font-size: 13px;
            padding: 0 20px 20px 20px;
            border-top: 1px solid rgba(0, 255, 65, 0.2);
        }
        .guide-collapsed .guide-steps { display: none; }
        .guide-collapsed .guide-arrow { transform: rotate(-90deg); }

        .step-number { font-weight: bold; color: var(--accent); display: block; margin-bottom: 5px; font-size: 16px; }
        .step-title { font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
        }
        .panel h3 { margin-top: 0; color: #888; font-size: 14px; text-transform: uppercase; }
        .big-number { font-size: 24px; font-weight: bold; color: var(--accent); }

        /* CONTROLS */
        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        input {
            background: #222;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            font-family: inherit;
            flex-grow: 1;
            width: 100%;
            box-sizing: border-box;
        }
        input:focus { outline: 1px solid var(--accent); }
        
        button {
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            padding: 10px 20px;
            border: none;
            transition: all 0.2s;
        }
        .btn-connect { background: var(--accent); color: black; width: 100%; font-size: 18px; margin-bottom: 20px; }
        .btn-connect:hover { box-shadow: 0 0 15px var(--accent); }
        .btn-action { background: #333; color: white; border: 1px solid #555; }
        .btn-action:hover { background: #444; border-color: #777; }
        
        .btn-burn-partial { background: #330000; border: 1px solid var(--danger); color: var(--danger); }
        .btn-burn-partial:hover { background: #550000; color: white; }
        
        .btn-burn-all { background: transparent; border: 1px solid var(--danger); color: var(--danger); width: 100%; margin-top:10px;}
        .btn-burn-all:hover { background: var(--danger); color: white; box-shadow: 0 0 15px var(--danger); }

        .loader { color: yellow; display: none; margin-top: 10px; text-align: center;}

        /* TABS */
        .tabs-container {
            margin-top: 50px;
            border-top: 1px solid var(--border);
            padding-top: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid var(--accent);
            color: var(--accent);
            text-decoration: none;
            padding: 12px 25px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: var(--accent);
            color: black;
            box-shadow: 0 0 15px var(--accent);
            transform: translateY(-2px);
        }

        .disclaimer-text {
            color: #555;
            font-size: 12px;
            margin-top: 30px;
            text-align: center;
            width: 100%;
            letter-spacing: 1px;
        }

        /* Mobile */
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .guide-steps { grid-template-columns: 1fr; text-align: left; }
            .tabs-container { flex-direction: column; align-items: stretch; }
            .nav-tab { justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-content">
            <h2 style="color: var(--danger);">‚ö† SOCIAL EXPERIMENT WARNING</h2>
            <p style="text-align: left; line-height: 1.6;">
                You are accessing <strong>ProjectM (SOAP)</strong>. By proceeding, you acknowledge:
                <br><br>
                1. <strong>NO ADMINS:</strong> The contract is immutable. Code is Law.<br>
                2. <strong>PERMANENT:</strong> All transactions are final.<br>
                3. <strong>HIGH RISK:</strong> You may lose your funds.<br>
                4. <strong>NOT INVESTMENT:</strong> This is a game theory experiment.
            </p>
            <button class="btn-danger" onclick="acceptRisk()">I ACCEPT THE RISKS</button>
        </div>
    </div>

    <div id="pm-modal-overlay">
        <div class="pm-modal-box" id="pm-modal-box">
            <div class="pm-modal-header">PROJECT-M SAYS:</div>
            <div class="pm-modal-content">
                <div id="pm-modal-message">Transaction details here...</div>
                <input type="text" id="pm-modal-input" class="pm-modal-input" autocomplete="off">
            </div>
            <div class="pm-modal-actions">
                <button id="pm-modal-cancel" class="pm-modal-btn">CANCEL</button>
                <button id="pm-modal-confirm" class="pm-modal-btn pm-btn-confirm">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <h1>PROJECT M <span class="status-dot">‚óè</span></h1>
            <p>SOAP | DECENTRALIZED | EXPERIMENTAL</p>
            <button id="btn-connect" class="btn-connect" onclick="connectWallet()">CONNECT WALLET</button>
        </header>

        <div class="guide-panel guide-collapsed" id="guide-panel">
            <div class="guide-header" onclick="toggleGuide()">
                <h3 style="margin:0; color:var(--accent);">QUICK START PROTOCOL</h3>
                <span class="guide-arrow" id="guide-arrow">‚ñº</span>
            </div>
            <div class="guide-steps">
                <div>
                    <span class="step-number">01. ENTER</span>
                    <span class="step-title">Join</span>
                    Buy 1.0 SOAP. The price is determined by the current Level.
                </div>
                <div>
                    <span class="step-number">02. HOLD</span>
                    <span class="step-title">Price Rises</span>
                    As more people join, the Level goes up. This grows the Treasury.
                </div>
                <div>
                    <span class="step-number">03. MINE</span>
                    <span class="step-title">Catch Up</span>
                    If the Level rises, you fall behind. Pay the difference to "Mine" and stay current.
                </div>
                <div>
                    <span class="step-number">04. EXIT</span>
                    <span class="step-title">Burn & Profit</span>
                    Burn your SOAP anytime to claim your % share of the Treasury (minus 4% tax).
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>Global State</h3>
                <div class="big-number">LVL <span id="global-level">-</span></div>
                <div style="margin-top:5px;">Price: <span id="global-price">-</span> ETH</div>
                <div style="margin-top:5px;">Treasury: <span id="global-treasury">-</span> ETH</div>
            </div>
            <div class="panel">
                <h3>My Stats</h3>
                <div class="big-number"><span id="user-balance">-</span> SOAP</div>
                <div>My Level: <span id="user-level">-</span></div>
                <div>Value if Burned: <span id="user-value" style="color: var(--danger);">-</span> ETH</div>
            </div>
        </div>

        <div class="panel">
            <h3>Actions</h3>
            
            <div class="action-row">
                <button class="btn-action" style="flex:1" onclick="joinGame()">JOIN (Buy 1.0 SOAP)</button>
            </div>
            <small style="color:#666;">Requires <span id="join-cost">-</span> ETH</small>
            
            <hr style="border-color:#333; margin: 20px 0;">

            <div class="action-row">
                <button id="btn-mine" class="btn-action" style="flex:1" onclick="mineTokens()">MINE (Catch Up)</button>
            </div>
            <small style="color:#666;">Mint tokens to match current level.</small>

            <hr style="border-color:#333; margin: 20px 0;">

            <h3 style="color:var(--danger); margin-bottom:10px;">EXIT STRATEGY</h3>
            
            <div class="action-row">
                <input type="number" id="burn-amount-input" placeholder="Amount to Burn (e.g. 1.0)">
                <button class="btn-burn-partial" onclick="burnPartial()">BURN X</button>
            </div>
            
            <button class="btn-burn-all" onclick="burnExit()">üî• BURN EVERYTHING & EXIT (4% TAX)</button>
            
            <div id="status-msg" class="loader">Processing Transaction...</div>
        </div>

        <div class="tabs-container">
            <a id="link-etherscan" href="#" target="_blank" class="nav-tab"><span>üîç</span> VERIFY CONTRACT</a>
            <a id="link-whitepaper" href="#" target="_blank" class="nav-tab"><span>üìÑ</span> WHITEPAPER</a>
            <a id="link-ecosystem" href="#" target="_blank" class="nav-tab"><span>üåê</span> MORE PROJECTS</a>
        </div>
        
        <div class="disclaimer-text">
            VERIFIED SOURCE CODE ‚Ä¢ NO ADMIN KEYS ‚Ä¢ 0x0 OWNER
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONTRACT_ADDRESS = "0x7ffD96BC3810BC570b07Df8412d657B2aC81410A"; 
        
        const WHITEPAPER_URL = "https://projectm.xyz/whitepaper.pdf"; 
        const ECOSYSTEM_URL = "https://t.me/ProjectM_Community";

        document.getElementById('link-etherscan').href = `https://etherscan.io/address/${CONTRACT_ADDRESS}#code`; 
        document.getElementById('link-whitepaper').href = WHITEPAPER_URL;
        document.getElementById('link-ecosystem').href = ECOSYSTEM_URL;

        const ABI = [
            "function join() external payable",
            "function mine() external payable",
            "function burnAllSoap() external",
            "function burnSoap(uint256 quantity) external",
            "function contractLevel() public view returns (uint256)",
            "function getCurrentPrice() public view returns (uint256)",
            "function levelOf(address user) public view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)",
            "function totalSupply() external view returns (uint256)"
        ];

        let provider, signer, contract;
        let currentPriceWei = ethers.BigNumber.from("0");

        // --- NEW CUSTOM DIALOG SYSTEM ---
        
        function showDialog(type, message, isDanger = false) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('pm-modal-overlay');
                const box = document.getElementById('pm-modal-box');
                const msgEl = document.getElementById('pm-modal-message');
                const inputEl = document.getElementById('pm-modal-input');
                const btnCancel = document.getElementById('pm-modal-cancel');
                const btnConfirm = document.getElementById('pm-modal-confirm');

                // Reset State
                msgEl.innerText = message;
                inputEl.value = '';
                overlay.style.display = 'flex';
                
                // Style based on Danger
                if(isDanger) {
                    box.classList.add('danger');
                    btnConfirm.style.color = 'var(--danger)';
                } else {
                    box.classList.remove('danger');
                    btnConfirm.style.color = 'var(--accent)';
                }

                // Setup Type
                if (type === 'alert') {
                    inputEl.style.display = 'none';
                    btnCancel.style.display = 'none';
                    btnConfirm.innerText = 'OK';
                } else if (type === 'confirm') {
                    inputEl.style.display = 'none';
                    btnCancel.style.display = 'block';
                    btnConfirm.innerText = 'CONFIRM';
                } else if (type === 'prompt') {
                    inputEl.style.display = 'block';
                    btnCancel.style.display = 'block';
                    btnConfirm.innerText = 'SUBMIT';
                    setTimeout(() => inputEl.focus(), 100);
                }

                // Event Handlers
                const close = (result) => {
                    overlay.style.display = 'none';
                    // Remove listeners to prevent stacking
                    btnCancel.onclick = null;
                    btnConfirm.onclick = null;
                    resolve(result);
                };

                btnCancel.onclick = () => close(false);
                btnConfirm.onclick = () => {
                    if (type === 'prompt') close(inputEl.value);
                    else close(true);
                };
            });
        }

        // --- UI LOGIC ---
        function acceptRisk() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('app-container').style.filter = 'none';
            document.getElementById('app-container').style.pointerEvents = 'all';
        }

        function toggleGuide() {
            const panel = document.getElementById('guide-panel');
            panel.classList.toggle('guide-collapsed');
        }

        async function connectWallet() {
            if (!window.ethereum) {
                await showDialog('alert', "Please install MetaMask!");
                return;
            }
            
            setLoading(true, "Connecting...");
            
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                const network = await provider.getNetwork();
                if (network.chainId !== 1) {
                    await showDialog('alert', "‚ö†Ô∏è WARNING: You are not connected to Ethereum Mainnet. Please switch networks.", true);
                }

                document.getElementById('btn-connect').innerText = "CONNECTED: " + address.slice(0,6) + "...";
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                await refreshData(address);
                setInterval(() => refreshData(address), 10000);
                
            } catch (e) {
                console.error(e);
                await showDialog('alert', "Connection Failed: " + e.message, true);
            }
            setLoading(false);
        }

        async function refreshData(address) {
            if(!contract) return;

            try {
                // 1. Global
                const cLevel = await contract.contractLevel();
                const cPrice = await contract.getCurrentPrice();
                document.getElementById('global-level').innerText = cLevel.toString();
                document.getElementById('global-price').innerText = ethers.utils.formatEther(cPrice);
                document.getElementById('join-cost').innerText = ethers.utils.formatEther(cPrice);
                currentPriceWei = cPrice;

                // 2. Treasury
                const treasuryWei = await provider.getBalance(CONTRACT_ADDRESS);
                document.getElementById('global-treasury').innerText = parseFloat(ethers.utils.formatEther(treasuryWei)).toFixed(4);

                // 3. User
                const userBal = await contract.balanceOf(address);
                const userLvl = await contract.levelOf(address);
                document.getElementById('user-balance').innerText = parseFloat(ethers.utils.formatEther(userBal)).toFixed(2);
                document.getElementById('user-level').innerText = userLvl.toString();

                // 4. Value
                const cSupply = await contract.totalSupply();
                let netValueEth = "0.0000";
                if (cSupply.gt(0) && userBal.gt(0)) {
                    const gross = userBal.mul(treasuryWei).div(cSupply);
                    const tax = gross.div(25); 
                    const net = gross.sub(tax);
                    netValueEth = parseFloat(ethers.utils.formatEther(net)).toFixed(4);
                }
                document.getElementById('user-value').innerText = netValueEth;

                // 5. Button
                updateMineButton(userBal, userLvl);
                
            } catch(e) { console.error("Error refreshing data:", e); }
        }

        function updateMineButton(userBal, userLvl) {
            const mineBtn = document.getElementById('btn-mine');
            const globalLevelText = document.getElementById('global-level').innerText;
            if(globalLevelText === "-") return;
            
            const globalLevel = parseInt(globalLevelText);
            const userLevelInt = parseInt(userLvl.toString());
            const needsMining = userBal.gt(0) && (globalLevel > userLevelInt);

            if (needsMining) {
                mineBtn.innerText = "‚ö†Ô∏è MINE REQUIRED (LEVEL UP)";
                mineBtn.style.border = "1px solid var(--danger)";
                mineBtn.style.color = "var(--danger)";
                mineBtn.style.background = "rgba(255, 50, 50, 0.1)";
            } else {
                mineBtn.innerText = "MINE (UP TO DATE)";
                mineBtn.style.border = "1px solid #333";
                mineBtn.style.color = "#777";
                mineBtn.style.background = "#222";
            }
        }

        // --- ACTIONS (Now using custom dialogs) ---
        async function joinGame() {
            if(!contract) return showDialog('alert', "Connect Wallet First");
            
            // Replaced alert/confirm logic
            const cost = ethers.utils.formatEther(currentPriceWei);
            const proceed = await showDialog('confirm', `JOIN THE LADDER?\nCost: ${cost} ETH`);
            if(!proceed) return;

            setLoading(true, "Confirm in Wallet...");
            try {
                const tx = await contract.join({ value: currentPriceWei, gasLimit: 300000 });
                setLoading(true, "Mining Transaction...");
                await tx.wait();
                await showDialog('alert', "Welcome to the experiment.");
                refreshData(await signer.getAddress());
            } catch (e) {
                console.error(e);
                await showDialog('alert', "Error: " + (e.reason || e.message), true);
            }
            setLoading(false);
        }

        async function mineTokens() {
            if(!contract) return showDialog('alert', "Connect Wallet First");
            
            const proceed = await showDialog('confirm', "MINE TOKENS?\nThis catches you up to current level.");
            if(!proceed) return;

            setLoading(true, "Confirm in Wallet...");
            try {
                const tx = await contract.mine({ value: currentPriceWei, gasLimit: 300000 });
                setLoading(true, "Mining Transaction...");
                await tx.wait();
                await showDialog('alert', "Mining Complete.");
                refreshData(await signer.getAddress());
            } catch (e) {
                await showDialog('alert', "Error: " + (e.reason || e.message), true);
            }
            setLoading(false);
        }

        async function burnPartial() {
            if(!contract) return showDialog('alert', "Connect Wallet First");
            const amount = document.getElementById('burn-amount-input').value;
            if(!amount || amount <= 0) return showDialog('alert', "Enter a valid amount", true);

            const proceed = await showDialog('confirm', `PERMANENTLY BURN ${amount} SOAP?\nYou will receive your % share of treasury.`, true);
            if(!proceed) return;
            
            setLoading(true, "Burning...");
            try {
                const weiAmount = ethers.utils.parseEther(amount.toString());
                const tx = await contract.burnSoap(weiAmount, { gasLimit: 300000 });
                await tx.wait();
                await showDialog('alert', "Tokens burned. ETH sent to wallet.");
                refreshData(await signer.getAddress());
            } catch (e) {
                await showDialog('alert', "Error: " + (e.reason || e.message), true);
            }
            setLoading(false);
        }

        async function burnExit() {
            const proceed = await showDialog('confirm', "‚ö† FINAL WARNING ‚ö†\n\nThis will BURN ALL your tokens and exit the game.\nAre you absolutely sure?", true);
            if(!proceed) return;

            setLoading(true, "Exiting...");
            try {
                const tx = await contract.burnAllSoap({ gasLimit: 300000 });
                await tx.wait();
                await showDialog('alert', "Successfully Exited.");
                refreshData(await signer.getAddress());
            } catch (e) {
                await showDialog('alert', "Error: " + (e.reason || e.message), true);
            }
            setLoading(false);
        }

        function setLoading(state, msg = "Processing...") {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.style.display = state ? 'block' : 'none';
        }
    </script>
</body>
</html>
