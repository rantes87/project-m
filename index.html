<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT M | SOAP PROTOCOL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --panel: #111;
            --border: #333;
            --accent: #00ff41; /* Hacker Green */
            --danger: #ff3333;
            --text: #eee;
            --font-mono: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-mono);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* DISCLAIMER MODAL */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--panel);
            border: 2px solid var(--danger);
            padding: 30px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 50, 50, 0.2);
        }
        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
            padding: 15px 30px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
        }
        .btn-danger:hover { background: #cc0000; }

        /* MAIN APP */
        #app-container {
            max-width: 800px;
            width: 100%;
            filter: blur(5px);
            pointer-events: none;
            flex-grow: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }
        h1 { margin: 0; letter-spacing: -2px; }
        .status-dot { color: var(--accent); }

        /* COLLAPSIBLE GUIDE SECTION */
        .guide-panel {
            background: rgba(0, 255, 65, 0.05);
            border: 1px dashed var(--accent);
            margin-bottom: 30px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .guide-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            user-select: none;
        }
        .guide-header:hover {
            background: rgba(0, 255, 65, 0.1);
        }
        .guide-arrow {
            font-size: 12px;
            transition: transform 0.3s;
        }
        .guide-steps {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
            font-size: 13px;
            padding: 0 20px 20px 20px;
            border-top: 1px solid rgba(0, 255, 65, 0.2);
        }
        
        /* Hidden state logic */
        .guide-collapsed .guide-steps { display: none; }
        .guide-collapsed .guide-arrow { transform: rotate(-90deg); }

        .step-number { font-weight: bold; color: var(--accent); display: block; margin-bottom: 5px; font-size: 16px; }
        .step-title { font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
        }
        .panel h3 { margin-top: 0; color: #888; font-size: 14px; text-transform: uppercase; }
        .big-number { font-size: 24px; font-weight: bold; color: var(--accent); }

        /* CONTROLS */
        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        input {
            background: #222;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            font-family: inherit;
            flex-grow: 1;
            width: 100%;
            box-sizing: border-box;
        }
        input:focus { outline: 1px solid var(--accent); }
        
        button {
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            padding: 10px 20px;
            border: none;
            transition: all 0.2s;
        }
        .btn-connect { background: var(--accent); color: black; width: 100%; font-size: 18px; margin-bottom: 20px; }
        .btn-connect:hover { box-shadow: 0 0 15px var(--accent); }
        .btn-action { background: #333; color: white; border: 1px solid #555; }
        .btn-action:hover { background: #444; border-color: #777; }
        
        /* Burn Specific Styles */
        .btn-burn-partial { background: #330000; border: 1px solid var(--danger); color: var(--danger); }
        .btn-burn-partial:hover { background: #550000; color: white; }
        
        .btn-burn-all { background: transparent; border: 1px solid var(--danger); color: var(--danger); width: 100%; margin-top:10px;}
        .btn-burn-all:hover { background: var(--danger); color: white; box-shadow: 0 0 15px var(--danger); }

        .loader { color: yellow; display: none; margin-top: 10px; text-align: center;}

        /* TABS DESIGN */
        .tabs-container {
            margin-top: 50px;
            border-top: 1px solid var(--border);
            padding-top: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid var(--accent);
            color: var(--accent);
            text-decoration: none;
            padding: 12px 25px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: var(--accent);
            color: black;
            box-shadow: 0 0 15px var(--accent);
            transform: translateY(-2px);
        }

        .disclaimer-text {
            color: #555;
            font-size: 12px;
            margin-top: 30px;
            text-align: center;
            width: 100%;
            letter-spacing: 1px;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .guide-steps { grid-template-columns: 1fr; text-align: left; }
            .tabs-container { flex-direction: column; align-items: stretch; }
            .nav-tab { justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-content">
            <h2 style="color: var(--danger);">‚ö† SOCIAL EXPERIMENT WARNING</h2>
            <p style="text-align: left; line-height: 1.6;">
                You are accessing <strong>ProjectM (SOAP)</strong>. By proceeding, you acknowledge:
                <br><br>
                1. <strong>NO ADMINS:</strong> The contract is immutable. Code is Law.<br>
                2. <strong>PERMANENT:</strong> All transactions are final.<br>
                3. <strong>HIGH RISK:</strong> You may lose your funds.<br>
                4. <strong>NOT INVESTMENT:</strong> This is a game theory experiment.
            </p>
            <button class="btn-danger" onclick="acceptRisk()">I ACCEPT THE RISKS</button>
        </div>
    </div>

    <div id="app-container">
        <header>
            <h1>PROJECT M <span class="status-dot">‚óè</span></h1>
            <p>SOAP | DECENTRALIZED | EXPERIMENTAL</p>
            <button id="btn-connect" class="btn-connect" onclick="connectWallet()">CONNECT WALLET</button>
        </header>

        <div class="guide-panel guide-collapsed" id="guide-panel">
            <div class="guide-header" onclick="toggleGuide()">
                <h3 style="margin:0; color:var(--accent);">QUICK START PROTOCOL</h3>
                <span class="guide-arrow" id="guide-arrow">‚ñº</span>
            </div>
            <div class="guide-steps">
                <div>
                    <span class="step-number">01. ENTER</span>
                    <span class="step-title">Join</span>
                    Buy 1.0 SOAP. The price is determined by the current Level.
                </div>
                <div>
                    <span class="step-number">02. HOLD</span>
                    <span class="step-title">Price Rises</span>
                    As more people join, the Level goes up. This grows the Treasury.
                </div>
                <div>
                    <span class="step-number">03. MINE</span>
                    <span class="step-title">Catch Up</span>
                    If the Level rises, you fall behind. Pay the difference to "Mine" and stay current.
                </div>
                <div>
                    <span class="step-number">04. EXIT</span>
                    <span class="step-title">Burn & Profit</span>
                    Burn your SOAP anytime to claim your % share of the Treasury (minus 4% tax).
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>Global State</h3>
                <div class="big-number">LVL <span id="global-level">-</span></div>
                <div style="margin-top:5px;">Price: <span id="global-price">-</span> ETH</div>
                <div style="margin-top:5px;">Treasury: <span id="global-treasury">-</span> ETH</div>
            </div>
            <div class="panel">
                <h3>My Stats</h3>
                <div class="big-number"><span id="user-balance">-</span> SOAP</div>
                <div>My Level: <span id="user-level">-</span></div>
                <div>Value if Burned: <span id="user-value" style="color: var(--danger);">-</span> ETH</div>
            </div>
        </div>

        <div class="panel">
            <h3>Actions</h3>
            
            <div class="action-row">
                <button class="btn-action" style="flex:1" onclick="joinGame()">JOIN (Buy 1.0 SOAP)</button>
            </div>
            <small style="color:#666;">Requires <span id="join-cost">-</span> ETH</small>
            
            <hr style="border-color:#333; margin: 20px 0;">

            <div class="action-row">
                <button id="btn-mine" class="btn-action" style="flex:1" onclick="mineTokens()">MINE (Catch Up)</button>
            </div>
            <small style="color:#666;">Mint tokens to match current level.</small>

            <hr style="border-color:#333; margin: 20px 0;">

            <h3 style="color:var(--danger); margin-bottom:10px;">EXIT STRATEGY</h3>
            
            <div class="action-row">
                <input type="number" id="burn-amount-input" placeholder="Amount to Burn (e.g. 1.0)">
                <button class="btn-burn-partial" onclick="burnPartial()">BURN X</button>
            </div>
            
            <button class="btn-burn-all" onclick="burnExit()">üî• BURN EVERYTHING & EXIT (4% TAX)</button>
            
            <div id="status-msg" class="loader">Processing Transaction...</div>
        </div>

        <div class="tabs-container">
            <a id="link-etherscan" href="#" target="_blank" class="nav-tab"><span>üîç</span> VERIFY CONTRACT</a>
            <a id="link-whitepaper" href="#" target="_blank" class="nav-tab"><span>üìÑ</span> WHITEPAPER</a>
            <a id="link-ecosystem" href="#" target="_blank" class="nav-tab"><span>üåê</span> MORE PROJECTS</a>
        </div>
        
        <div class="disclaimer-text">
            VERIFIED SOURCE CODE ‚Ä¢ NO ADMIN KEYS ‚Ä¢ 0x0 OWNER
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONTRACT_ADDRESS = "0x7ffD96BC3810BC570b07Df8412d657B2aC81410A"; 
        
        const WHITEPAPER_URL = "https://projectm.xyz/whitepaper.pdf"; 
        const ECOSYSTEM_URL = "https://t.me/ProjectM_Community";

        // AUTO-UPDATE LINKS
        document.getElementById('link-etherscan').href = `https://etherscan.io/address/${CONTRACT_ADDRESS}#code`; 
        document.getElementById('link-whitepaper').href = WHITEPAPER_URL;
        document.getElementById('link-ecosystem').href = ECOSYSTEM_URL;

        // UPDATED ABI TO MATCH THE NEW SOLIDITY CODE
        const ABI = [
            // Write Functions
            "function join() external payable",
            "function mine() external payable",
            "function burnAllSoap() external",
            "function burnSoap(uint256 quantity) external",
            // Read Functions (Variables as functions)
            "function contractLevel() public view returns (uint256)",
            "function getCurrentPrice() public view returns (uint256)",
            "function levelOf(address user) public view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)",
            "function totalSupply() external view returns (uint256)"
        ];

        let provider, signer, contract;
        let currentPriceWei = 0;

        // --- UI LOGIC ---
        function acceptRisk() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('app-container').style.filter = 'none';
            document.getElementById('app-container').style.pointerEvents = 'all';
        }

        function toggleGuide() {
            const panel = document.getElementById('guide-panel');
            panel.classList.toggle('guide-collapsed');
        }

        async function connectWallet() {
            if (!window.ethereum) return alert("Please install MetaMask!");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                document.getElementById('btn-connect').innerText = "CONNECTED: " + address.slice(0,6) + "...";
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                refreshData(address);
                setInterval(() => refreshData(address), 10000); // Auto-refresh every 10s
            } catch (e) {
                console.error(e);
                alert("Connection Failed");
            }
        }

        async function refreshData(address) {
            if(!contract) return;
            try {
                // The new contract doesn't have projectStats(), so we fetch data individually using Promise.all for speed
                const [
                    cLevel,
                    cPrice,
                    userLvl,
                    userBal,
                    cSupply,
                    treasuryWei
                ] = await Promise.all([
                    contract.contractLevel(),
                    contract.getCurrentPrice(),
                    contract.levelOf(address),
                    contract.balanceOf(address),
                    contract.totalSupply(),
                    provider.getBalance(CONTRACT_ADDRESS) // Get ETH balance of contract directly from provider
                ]);

                // 1. UPDATE GLOBAL STATE
                document.getElementById('global-level').innerText = cLevel.toString();
                document.getElementById('global-price').innerText = ethers.utils.formatEther(cPrice);
                document.getElementById('global-treasury').innerText = parseFloat(ethers.utils.formatEther(treasuryWei)).toFixed(4);
                
                document.getElementById('join-cost').innerText = ethers.utils.formatEther(cPrice);
                currentPriceWei = cPrice;

                // 2. UPDATE USER STATS
                document.getElementById('user-balance').innerText = parseFloat(ethers.utils.formatEther(userBal)).toFixed(2);
                document.getElementById('user-level').innerText = userLvl.toString();

                // 3. CALCULATE BURN VALUE (Manual Math based on Solidity Logic)
                // Logic: Gross = (UserBalance * Treasury) / TotalSupply
                //        Net   = Gross - (Gross / 25)
                let netValueEth = "0.0000";
                
                if (cSupply.gt(0) && userBal.gt(0)) {
                    const gross = userBal.mul(treasuryWei).div(cSupply);
                    const tax = gross.div(25); // 4%
                    const net = gross.sub(tax);
                    netValueEth = parseFloat(ethers.utils.formatEther(net)).toFixed(4);
                }
                document.getElementById('user-value').innerText = netValueEth;
                
                // 4. SMART MINE BUTTON
                const mineBtn = document.getElementById('btn-mine');
                // Needs mining if user has tokens AND their level is less than contract level
                const needsMining = userBal.gt(0) && cLevel.gt(userLvl);

                if (needsMining) {
                    mineBtn.innerText = "‚ö†Ô∏è MINE REQUIRED (LEVEL UP)";
                    mineBtn.style.border = "1px solid var(--danger)";
                    mineBtn.style.color = "var(--danger)";
                    mineBtn.style.background = "rgba(255, 50, 50, 0.1)";
                } else {
                    mineBtn.innerText = "MINE (UP TO DATE)";
                    mineBtn.style.border = "1px solid #333";
                    mineBtn.style.color = "#777";
                    mineBtn.style.background = "#222";
                }

            } catch (e) {
                console.log("Data refresh error:", e);
            }
        }

        // --- ACTIONS ---
        async function joinGame() {
            if(!contract) return alert("Connect Wallet First");
            setLoading(true);
            try {
                // Assuming standard gas limit, increase slightly for safety
                const tx = await contract.join({ value: currentPriceWei, gasLimit: 200000 });
                await tx.wait();
                alert("Welcome to the experiment.");
                refreshData(await signer.getAddress());
            } catch (e) {
                alert("Error: " + (e.reason || e.message));
            }
            setLoading(false);
        }

        async function mineTokens() {
            if(!contract) return alert("Connect Wallet First");
            setLoading(true);
            try {
                const tx = await contract.mine({ value: currentPriceWei, gasLimit: 200000 });
                await tx.wait();
                alert("Mining Complete.");
                refreshData(await signer.getAddress());
            } catch (e) {
                alert("Error: " + (e.reason || e.message));
            }
            setLoading(false);
        }

        async function burnPartial() {
            if(!contract) return alert("Connect Wallet First");
            const amount = document.getElementById('burn-amount-input').value;
            if(!amount || amount <= 0) return alert("Enter a valid amount");

            if(!confirm(`Burn ${amount} SOAP?`)) return;
            
            setLoading(true);
            try {
                const weiAmount = ethers.utils.parseEther(amount.toString());
                const tx = await contract.burnSoap(weiAmount);
                await tx.wait();
                alert("Tokens burned.");
                refreshData(await signer.getAddress());
            } catch (e) {
                alert("Error: " + (e.reason || e.message));
            }
            setLoading(false);
        }

        async function burnExit() {
            if(!confirm("Are you sure? This will burn ALL your tokens.")) return;
            setLoading(true);
            try {
                const tx = await contract.burnAllSoap();
                await tx.wait();
                alert("Successfully Exited.");
                refreshData(await signer.getAddress());
            } catch (e) {
                alert("Error: " + (e.reason || e.message));
            }
            setLoading(false);
        }

        function setLoading(state) {
            document.getElementById('status-msg').style.display = state ? 'block' : 'none';
        }
    </script>
</body>
</html>
